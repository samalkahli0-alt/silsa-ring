<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>معايرة ومضاهاة مقاس الخاتم</title>
<style>
  body{font-family:sans-serif;display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;background:#fafafa;margin:0;padding:20px;text-align:center}
  .card{background:#eee;border:2px dashed #44080f;margin-bottom:12px;transition:width .15s,height .15s}
  .label{color:#44080f;font-weight:700;margin:8px 0}
  .controls{max-width:420px;width:100%}
  input[type=range]{width:100%}
  .divider{height:1px;background:#ddd;width:100%;margin:18px 0}
  .circle{background:#44080f;border-radius:50%;margin:14px 0;transition:width .2s,height .2s;display:inline-block}
  .overlay-wrap{position:relative;display:inline-block}
  .overlay-ring{
    position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
    border:4px solid rgba(68,8,15,0.9);border-radius:50%;box-sizing:border-box;
    background:transparent;pointer-events:none;
  }
  .btn{background:#44080f;color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;margin:6px}
  .small{font-size:13px;color:#666}
  select,input[type=number]{padding:6px;border:1px solid #ccc;border-radius:6px}
</style>
</head>
<body>

  <h2>معايرة الشاشة + مضاهاة الخاتم</h2>

  <!-- STEP 1: بطاقة بالطول -->
  <div class="label">🔧 خطوة 1: عاير الشاشة باستخدام بطاقة (ضعها عموديًا)</div>
  <div id="card" class="card"></div>
  <div class="controls">
    <input id="calibrate" type="range" min="100" max="500" value="200">
    <div class="small">الطول الحالي: <span id="calLabel">200</span> px</div>
  </div>

  <div class="divider"></div>

  <!-- STEP 2: محاكاة الخاتم العادية -->
  <div class="label">💍 خطوة 2: اختيار مقاس الخاتم أو استخدام الـOverlay</div>

  <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:center;margin-bottom:8px">
    <label class="small">طريقة المحاكاة:</label>
    <select id="mode">
      <option value="auto">اعرض دائرة بالحجم (اعتماد جدول القُطر الداخلي)</option>
      <option value="overlay">مضاهاة بالخاتم الفعلي فوق الشاشة (Overlay)</option>
    </select>
  </div>

  <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:center;margin-bottom:8px">
    <label class="small">اختر المقاس (US)</label>
    <select id="ringSize">
      <option value="5">5</option><option value="6" selected>6</option><option value="7">7</option>
      <option value="8">8</option><option value="9">9</option><option value="10">10</option>
      <option value="11">11</option><option value="12">12</option><option value="13">13</option>
    </select>

    <label class="small">أو أدخل قطر داخلي مباشر (مم):</label>
    <input id="manualMM" type="number" step="0.1" placeholder="مثال 16.5" style="width:95px">
  </div>

  <!-- area to show circle and overlay -->
  <div class="overlay-wrap" id="displayArea" style="margin-top:8px">
    <div id="simCircle" class="circle"></div>
    <div id="overlayRing" class="overlay-ring" style="display:none"></div>
  </div>

  <div style="width:320px;margin-top:8px">
    <input id="ringSlider" type="range" min="5" max="13" step="0.5" value="6">
    <div class="small">المقاس المعروض: <span id="ringLabel">6 (16.5 مم)</span></div>
  </div>

  <div style="margin-top:12px">
    <button id="applyOverlay" class="btn" style="display:none">اعتماد مقاس الـOverlay</button>
    <button id="savePx" class="btn" style="background:#2a7f5f">حفظ px/mm (local)</button>
    <button id="reset" class="btn" style="background:#777">إعادة ضبط</button>
  </div>

  <div style="margin-top:12px" class="small">حاليًا: 1 مم = <span id="pxmm">—</span> px</div>

<script>
  // CARD (vertical)
  const CARD_WIDTH_MM = 53.98, CARD_HEIGHT_MM = 85.6; // we use height as controlled
  const card = document.getElementById('card');
  const calSlider = document.getElementById('calibrate');
  const calLabel = document.getElementById('calLabel');

  // ring sizes (INNER DIAMETER in mm) — ensure these are inner diameters
  const ringSizes = {5:15.7,6:16.5,7:17.3,8:18.1,9:18.9,10:19.8,11:20.6,12:21.4,13:22.2};

  // UI elements
  const mode = document.getElementById('mode');
  const ringSize = document.getElementById('ringSize');
  const manualMM = document.getElementById('manualMM');
  const simCircle = document.getElementById('simCircle');
  const ringSlider = document.getElementById('ringSlider');
  const ringLabel = document.getElementById('ringLabel');
  const overlayRing = document.getElementById('overlayRing');
  const displayArea = document.getElementById('displayArea');
  const applyOverlay = document.getElementById('applyOverlay');
  const pxmmEl = document.getElementById('pxmm');
  const savePx = document.getElementById('savePx');
  const reset = document.getElementById('reset');

  let pxPerMM = localStorage.getItem('pxPerMM') ? parseFloat(localStorage.getItem('pxPerMM')) : null;

  // initial card setup (height controlled)
  function setCardHeight(h){
    const ratio = CARD_WIDTH_MM / CARD_HEIGHT_MM;
    card.style.height = h + 'px';
    card.style.width = (h * ratio) + 'px';
    calLabel.textContent = h;
    // compute pxPerMM from height (height corresponds to CARD_HEIGHT_MM)
    pxPerMM = h / CARD_HEIGHT_MM;
    updateDisplay();
  }

  calSlider.addEventListener('input', ()=> setCardHeight(parseInt(calSlider.value)));

  // set initial from saved or default
  if(pxPerMM){
    // derive a reasonable card height from stored px/mm
    const h = Math.round(pxPerMM * CARD_HEIGHT_MM);
    calSlider.value = Math.min(500, Math.max(100, h));
  }
  setCardHeight(parseInt(calSlider.value));

  // update display (circle or overlay)
  function getSelectedDiameterMM(){
    const manual = parseFloat(manualMM.value);
    if(!isNaN(manual) && manual>0) return manual;
    const s = parseFloat(ringSize.value);
    return ringSizes[s];
  }

  function updateDisplay(){
    pxmmEl.textContent = pxPerMM ? pxPerMM.toFixed(3) : '—';
    const diamMM = getSelectedDiameterMM();
    ringLabel.textContent = `${ringSlider.value} (${diamMM} مم)`;

    if(mode.value === 'auto'){
      overlayRing.style.display = 'none';
      applyOverlay.style.display = 'none';
      simCircle.style.display = 'inline-block';
      // compute px diameter from pxPerMM
      const diamPX = diamMM * pxPerMM;
      simCircle.style.width = diamPX + 'px';
      simCircle.style.height = diamPX + 'px';
      // center display area sizing
      displayArea.style.width = Math.max(200, diamPX + 80) + 'px';
      displayArea.style.height = Math.max(200, diamPX + 80) + 'px';
    } else {
      // overlay mode: show transparent ring outline to match real ring
      simCircle.style.display = 'none';
      overlayRing.style.display = 'block';
      applyOverlay.style.display = 'inline-block';
      // overlay initial size: use selected diameter if pxPerMM known, else use mid size
      const initPX = pxPerMM ? diamMM * pxPerMM : 150;
      setOverlaySize(initPX);
    }
  }

  // overlay resizing: user can use mouse wheel or pinch? we'll attach a hidden slider via keyboard +/- and mousewheel
  let overlayPX = 150;
  function setOverlaySize(px){
    overlayPX = px;
    overlayRing.style.width = overlayPX + 'px';
    overlayRing.style.height = overlayPX + 'px';
    // border thickness proportional (visual)
    overlayRing.style.borderWidth = Math.max(3, Math.round(overlayPX * 0.03)) + 'px';
    displayArea.style.width = Math.max(200, overlayPX + 80) + 'px';
    displayArea.style.height = Math.max(200, overlayPX + 80) + 'px';
  }

  // Allow mouse wheel over displayArea to change overlay size
  displayArea.addEventListener('wheel', (e)=>{
    if(mode.value !== 'overlay') return;
    e.preventDefault();
    const delta = e.deltaY > 0 ? -4 : 4;
    setOverlaySize(Math.max(30, overlayPX + delta));
  });

  // also allow +/- keys when overlay active
  window.addEventListener('keydown',(e)=>{
    if(mode.value !== 'overlay') return;
    if(e.key === '+' || e.key === '=' ) setOverlaySize(overlayPX + 4);
    if(e.key === '-' ) setOverlaySize(Math.max(10, overlayPX - 4));
  });

  // apply overlay: user must tell us the real diameter (from select or manual). Then we compute pxPerMM.
  applyOverlay.addEventListener('click', ()=>{
    const diamMM = getSelectedDiameterMM();
    if(!diamMM || diamMM <= 0){ alert('أدخل قطرًا صحيحًا بالخانات أعلى (مثال 16.5 مم)'); return; }
    // overlayPX corresponds to diamPX of inner diameter
    pxPerMM = overlayPX / diamMM;
    localStorage.setItem('pxPerMM', pxPerMM.toString());
    alert('تم اعتماد المعايرة من الـOverlay. الآن المحاكاة ستطابق الخاتم الذي وضعته.');
    updateDisplay();
  });

  // mode change
  mode.addEventListener('change', ()=>{
    if(mode.value === 'overlay'){
      ringSlider.disabled = true;
      applyOverlay.style.display = 'inline-block';
      overlayRing.style.display = 'block';
      simCircle.style.display = 'none';
    } else {
      ringSlider.disabled = false;
      overlayRing.style.display = 'none';
      applyOverlay.style.display = 'none';
      simCircle.style.display = 'inline-block';
    }
    updateDisplay();
  });

  // keep ringSlider & select in sync (slider changes the chosen size)
  ringSlider.addEventListener('input', ()=>{
    ringSize.value = ringSlider.value;
    updateDisplay();
  });
  ringSize.addEventListener('change', ()=>{ ringSlider.value = ringSize.value; updateDisplay();});
  manualMM.addEventListener('input', updateDisplay);

  // save px/mm
  savePx.addEventListener('click', ()=>{
    if(!pxPerMM){ alert('لا توجد قيمة px/mm حالياً للحفظ'); return; }
    localStorage.setItem('pxPerMM', pxPerMM.toString());
    alert('تم حفظ المعايرة في المتصفح. ستبقى حتى تمسح التخزين المحلي.');
  });

  // reset
  reset.addEventListener('click', ()=>{
    localStorage.removeItem('pxPerMM');
    pxPerMM = null;
    calSlider.value = 200;
    manualMM.value = '';
    ringSize.value = '6';
    ringSlider.value = '6';
    mode.value = 'auto';
    updateDisplay();
  });

  // initialize UI
  updateDisplay();
</script>

</body>
</html>

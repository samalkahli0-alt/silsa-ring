<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ğŸ’ Ù…Ø­Ø§ÙƒØ§Ø© Ù…Ù‚Ø§Ø³ Ø§Ù„Ø®Ø§ØªÙ… â€” SILSA</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#ffeed3;
      --ink:#3e000c;
      --muted:#7e4a55;
      --card:#fff7ea;
      --border:#f1d7b8;
      --accent:#b8860b;
      --accent-2:#d4af37;
      --diamond-1:#89CFF0;
      --diamond-2:#bde3fb;
      --danger:#c81e1e;
      --navy:#001f3f;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:'Tajawal',system-ui,Arial}

    .wrap{max-width:1100px;margin:24px auto;padding:16px}
    .title{font-size:26px;font-weight:800;margin:0 0 14px;display:flex;gap:10px;align-items:center}
    .subtitle{color:var(--muted);margin-bottom:18px}

    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:16px}
    @media (max-width:880px){.grid{grid-template-columns:1fr;}}

    .card{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:16px}

    label{font-size:14px;color:var(--muted);display:block;margin-bottom:6px}
    input,select{
      width:100%;padding:10px 12px;border:1px solid var(--border);
      border-radius:12px;font-size:16px;background:#fff;
      outline:none;color:var(--ink)
    }
    input:focus,select:focus{
      border-color:var(--accent);box-shadow:0 0 0 3px rgba(212,175,55,.18)
    }

    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .full{grid-column:1/-1}

    .error{color:var(--danger);font-weight:800;margin-top:8px;min-height:1.5em}
    .laser{color:var(--navy);font-weight:800;margin-top:8px;white-space:pre-line;min-height:2.6em}

    .canvas-card{display:flex;flex-direction:column;align-items:center;gap:10px}
    svg{max-width:380px;height:auto;display:block}

    /* ğŸ”¥ Ø¥Ø·Ø§Ø± Ø§Ù„Ø¯Ø§Ø¦Ø±Ø© */
    .ring-border{
      stroke:#b8860b;
      stroke-width:4;
      fill:none;
      opacity:.7;
    }

    .size-label{font-weight:800;color:var(--ink)}

    .ring-stroke{stroke:url(#ringGrad);stroke-width:12;fill:url(#ringFill);filter:drop-shadow(0 6px 12px rgba(62,0,12,.12))}
    .ring-stroke-inner{stroke:url(#innerGrad);stroke-width:4;fill:#fff}

    .diamond{filter:drop-shadow(0 3px 6px rgba(0,0,0,.15))}

    .slider-wrap{display:flex;align-items:center;gap:10px;width:100%}
    input[type=range]{
      appearance:none;width:100%;height:6px;border-radius:999px;background:#ead8bb;outline:none
    }
    input[type=range]::-webkit-slider-thumb{
      appearance:none;width:18px;height:18px;border-radius:50%;
      background:var(--accent-2);border:2px solid #fff;
      box-shadow:0 0 0 2px rgba(212,175,55,.35);cursor:pointer
    }

    @keyframes sparkle{
      0%{fill:var(--diamond-1)}
      50%{fill:var(--diamond-2)}
      100%{fill:var(--diamond-1)}
    }
    .sparkle{animation:sparkle 1.2s ease-in-out infinite}

    .hint{font-size:12px;color:var(--muted)}

    /* ğŸ”¥ Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø¹Ø§ÙŠØ±Ø© */
    #calibrationScreen{
      display:none;
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.75);
      backdrop-filter:blur(4px);
      z-index:9999;
      color:white;

      /* â†“â†“â†“ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ â†“â†“â†“ */
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      gap:20px;
      overflow:hidden;
      text-align:center;
      padding:20px;
    }

    /* ğŸ”¥ Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© + Ø¥Ø·Ø§Ø± Ø³ÙŠÙ„Ø³Ø§ Ø§Ù„Ø¹Ù†Ø§Ø¨ÙŠ */
    #cardBox{
      background:white;
      width:60px;
      height:120px;
      border:5px solid #3e000c;
      border-radius:12px;
    }
  </style>
</head>

<body>
  <div class="wrap">

    <h1 class="title">ğŸ’ Ù…Ø­Ø§ÙƒØ§Ø© Ù…Ù‚Ø§Ø³ Ø§Ù„Ø®Ø§ØªÙ… â€” SILSA</h1>
    <div class="subtitle">Ø§Ø¶Ø¨Ø·ÙŠ Ø§Ù„Ù…Ù‚Ø§Ø³ Ø¨Ø¯Ù‚Ø©ØŒ ÙˆÙƒÙ„ Ø´ÙŠØ¡ ÙŠØ­Ø¯Ø« ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ âœ¨</div>

    <div class="grid">

      <!-- Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„Ø§Øª -->
      <div class="card">

        <label style="font-weight:700;margin-bottom:12px">Ù…Ø¹Ø§ÙŠØ±Ø© Ø§Ù„Ø´Ø§Ø´Ø©</label>

        <button id="startCalib"
          style="padding:12px;border-radius:10px;background:var(--accent);color:white;border:none;font-size:16px;width:100%;margin-bottom:15px">
          Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø¹Ø§ÙŠØ±Ø©
        </button>

        <label>Ø§Ù„Ø´Ø±ÙƒØ©</label>
        <select id="brandSelect">
          <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø´Ø±ÙƒØ©</option>
        </select>

        <label style="margin-top:12px">Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„</label>
        <select id="modelSelect" disabled>
          <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„</option>
        </select>

        <div id="calibStatus" class="hint" style="margin-top:12px">Ù„Ù… ØªØªÙ… Ø§Ù„Ù…Ø¹Ø§ÙŠØ±Ø© Ø¨Ø¹Ø¯</div>

      </div>

      <!-- Ø§Ù„Ø±Ø³Ù… -->
      <div class="card canvas-card">
        <div id="sizeLabel" class="size-label">Ø§Ù„Ù…Ù‚Ø§Ø³ Ø§Ù„Ø­Ø§Ù„ÙŠ: â€” (US)</div>

        <svg id="ringSvg" viewBox="0 0 360 360">

          <!-- ğŸ”¥ Ø¥Ø·Ø§Ø± Ø§Ù„Ø¯Ø§Ø¦Ø±Ø© -->
          <circle class="ring-border" cx="180" cy="190" r="95" />

          <defs>
            <linearGradient id="ringGrad" x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%" stop-color="#d9d9d9"/>
              <stop offset="50%" stop-color="#f3f3f3"/>
              <stop offset="100%" stop-color="#c6c6c6"/>
            </linearGradient>

            <linearGradient id="innerGrad" x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%" stop-color="#eee"/>
              <stop offset="100%" stop-color="#fafafa"/>
            </linearGradient>

            <radialGradient id="ringFill" cx="50%" cy="40%" r="65%">
              <stop offset="0%" stop-color="#ffffff"/>
              <stop offset="60%" stop-color="#f7f7f7"/>
              <stop offset="100%" stop-color="#f0f0f0"/>
            </radialGradient>
          </defs>

          <circle id="outer" class="ring-stroke" cx="180" cy="190" r="60" />
          <circle id="inner" class="ring-stroke-inner" cx="180" cy="190" r="35" />

          <polygon id="diamond" class="sparkle diamond"
            points="180,90 170,100 180,110 190,100"
            fill="#89CFF0" stroke="#5a9bd4" stroke-width="2" />
        </svg>

        <div class="slider-wrap">
          <span class="hint">4</span>
          <input id="slider" type="range" min="4" max="14" step="0.5" value="8" />
          <span class="hint">14</span>
        </div>

        <div class="hint">Ø§Ø³Ø­Ø¨ÙŠ Ø§Ù„Ø´Ø±ÙŠØ· Ø£Ùˆ Ø¹Ø¯Ù‘Ù„ÙŠ Ø£ÙŠ Ø®Ø§Ù†Ø© Ø¨Ø§Ù„Ø£Ø¹Ù„Ù‰</div>
      </div>

    </div>
  </div>

  <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø¹Ø§ÙŠØ±Ø© -->
  <div id="calibrationScreen">
    <h2>ğŸ”§ Ø§Ù„Ù…Ø¹Ø§ÙŠØ±Ø©</h2>
    <p>Ø¶Ø¹ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¨Ù†Ùƒ Ø¨Ø´ÙƒÙ„ Ø·ÙˆÙ„ÙŠ Ø«Ù… Ø­Ø±Ù‘Ùƒ Ø§Ù„Ø´Ø±ÙŠØ· Ø­ØªÙ‰ ÙŠØ·Ø§Ø¨Ù‚ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ Ø·ÙˆÙ„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©.</p>

    <div id="cardBox"></div>

    <input id="calibSlider" type="range" style="width:80%;max-width:350px">

    <button id="doneCalib"
      style="padding:12px;border-radius:10px;background:var(--accent);color:white;border:none;font-size:17px;width:80%;max-width:330px">
      Ø­ÙØ¸ ÙˆØ¥ØºÙ„Ø§Ù‚
    </button>
  </div>

<script>
/* =================  ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©  =================== */
fetch("data/devices.json")
.then(res => res.json())
.then(devices => initDeviceSelector(devices));

const brandSelect=document.getElementById("brandSelect");
const modelSelect=document.getElementById("modelSelect");

const calibScreen=document.getElementById("calibrationScreen");
const calibSlider=document.getElementById("calibSlider");
const cardBox=document.getElementById("cardBox");
const startCalib=document.getElementById("startCalib");
const doneCalib=document.getElementById("doneCalib");
const calibStatus=document.getElementById("calibStatus");

let selectedDevice=null;
let scaleFactor=localStorage.scaleFactor?parseFloat(localStorage.scaleFactor):6.8;

function initDeviceSelector(devices){
  for(const brand of Object.keys(devices)){
    let opt=document.createElement("option");
    opt.value=brand;
    opt.textContent=brand;
    brandSelect.appendChild(opt);
  }

  brandSelect.addEventListener("change",()=>{
    modelSelect.innerHTML=`<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„</option>`;
    modelSelect.disabled=true;
    const brand=brandSelect.value;
    if(!brand)return;

    devices[brand].forEach(d=>{
      let op=document.createElement("option");
      op.value=JSON.stringify(d);
      op.textContent=d.model;
      modelSelect.appendChild(op);
    });
    modelSelect.disabled=false;
  });

  modelSelect.addEventListener("change",()=>{
    selectedDevice=JSON.parse(modelSelect.value);
  });
}

/* ====================  Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø¹Ø§ÙŠØ±Ø© ====================== */

function updateCardBoxFromSlider(){
  const px=parseFloat(calibSlider.value);
  const ratio=53.98/85.6;
  cardBox.style.height=px+"px";
  cardBox.style.width=(px*ratio)+"px";
}

startCalib.addEventListener("click",()=>{
  if(!selectedDevice){
    alert("Ø§Ø®ØªØ± Ø§Ù„Ø´Ø±ÙƒØ© ÙˆØ§Ù„Ù…ÙˆØ¯ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹");
    return;
  }

  const maxPx=Math.round(window.innerHeight*0.8);
  const minPx=Math.round(maxPx*0.2);

  calibSlider.min=minPx;
  calibSlider.max=maxPx;

  /* ğŸ”¥ Ø­Ø¬Ù… Ø£ÙˆÙ„ÙŠ ØµØºÙŠØ± ÙˆÙ…Ù†Ø§Ø³Ø¨ */
  calibSlider.value=Math.round(window.innerHeight*0.30);
  updateCardBoxFromSlider();

  calibScreen.style.display="flex";
});

calibSlider.addEventListener("input",updateCardBoxFromSlider);

doneCalib.addEventListener("click",()=>{
  const px=parseFloat(calibSlider.value);
  const realMM=85.6;
  scaleFactor=px/realMM;
  localStorage.setItem("scaleFactor",scaleFactor);

  calibStatus.textContent="âœ” ØªÙ…Øª Ø§Ù„Ù…Ø¹Ø§ÙŠØ±Ø© Ø¨Ù†Ø¬Ø§Ø­";
  calibStatus.style.color="green";

  calibScreen.style.display="none";

  pxPerMM=scaleFactor;
});

/* ===================  ÙƒÙˆØ¯ Ø±Ø³Ù… Ø§Ù„Ø®Ø§ØªÙ… Ø§Ù„Ø£ØµÙ„ÙŠ =================== */

let pxPerMM=scaleFactor;
const PI=Math.PI;
const US_MIN=4,US_MAX=14;

const usToDiameter=us=>11.63+0.8128*us;
const diameterToUs=d=>(d-11.63)/0.8128;
const diameterToCirc=d=>PI*d;
const usToJP=us=>us+12;

const UK_STEPS=[
"H","HÂ½","I","IÂ½","J","JÂ½","K","KÂ½","L","LÂ½","M","MÂ½","N","NÂ½",
"O","OÂ½","P","PÂ½","Q","QÂ½","R","RÂ½","S","SÂ½","T","TÂ½",
"U","UÂ½","V","VÂ½","W","WÂ½","X","XÂ½","Y","YÂ½","Z","Z+Â½","Z+1"
];

const usToUK=(us)=>{
  const idx=(us-US_MIN)/(US_MAX-US_MIN)*(UK_STEPS.length-1);
  return UK_STEPS[Math.round(Math.max(0,Math.min(idx,UK_STEPS.length-1)))];
};

const normalizeUK=s=>s.trim().toUpperCase().replace("1/2","Â½");

const ukToUs=uk=>{
  const i=UK_STEPS.indexOf(normalizeUK(uk));
  if(i<0)return null;
  return US_MIN+(i/(UK_STEPS.length-1))*(US_MAX-US_MIN);
};

let updating=false;

const fmt=(n,d=2)=>Number(n).toFixed(d).replace(/\.0+$/,'').replace(/\.$/,'');

const el={
  us:document.getElementById("us"),
  uk:document.getElementById("uk"),
  fr:document.getElementById("fr"),
  jp:document.getElementById("jp"),
  diameter:document.getElementById("diameter"),
  circ:document.getElementById("circ"),
  error:document.getElementById("error"),
  laser:document.getElementById("laser"),
  slider:document.getElementById("slider"),
  sizeLabel:document.getElementById("sizeLabel"),
  outer:document.getElementById("outer"),
  inner:document.getElementById("inner"),
  diamond:document.getElementById("diamond")
};

function drawRing(mm){
  const r=(mm/2)*pxPerMM;
  const cx=180, cy=190;

  el.outer.setAttribute("r",r);
  el.inner.setAttribute("r",r/1.7);

  const dy=cy-r-20;
  el.diamond.setAttribute("points",
    `${cx},${dy-8} ${cx-10},${dy} ${cx},${dy+8} ${cx+10},${dy}`
  );
}

function updateAllFromUS(us){
  if(us<US_MIN||us>US_MAX){
    el.error.textContent="âŒ Ø§Ù„Ù…Ù‚Ø§Ø³ Ø®Ø§Ø±Ø¬ Ø§Ù„Ù†Ø·Ø§Ù‚ (4 â€” 14)";
    return;
  }
  el.error.textContent="";

  const d=usToDiameter(us);
  const c=diameterToCirc(d);
  const jp=usToJP(us);
  const uk=usToUK(us);

  updating=true;
  el.us.value=fmt(us);
  el.uk.value=uk;
  el.fr.value=fmt(c,1);
  el.jp.value=fmt(jp,1);
  el.diameter.value=fmt(d,2);
  el.circ.value=fmt(c,1);
  el.slider.value=us;
  updating=false;

  el.sizeLabel.textContent=`Ø§Ù„Ù…Ù‚Ø§Ø³ Ø§Ù„Ø­Ø§Ù„ÙŠ: ${fmt(us,1)} (US)`;
  drawRing(d);
  el.laser.textContent=`Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø© Ù„Ù„Ù…Ø§ÙƒÙŠÙ†Ø©: ${fmt(c,1)} mm`;
}

const tryNum=v=>{
  if(!v)return null;
  const n=Number((""+v).trim());
  return Number.isFinite(n)?n:null;
};

el.us.addEventListener("input",()=>{if(!updating){let n=tryNum(el.us.value);if(n!=null)updateAllFromUS(n)}})
el.uk.addEventListener("input",()=>{if(!updating){let u=ukToUs(el.uk.value);if(u!=null)updateAllFromUS(u)}})
el.fr.addEventListener("input",()=>{if(!updating){let n=tryNum(el.fr.value);if(n!=null)updateAllFromUS(diameterToUs(n/PI))}})
el.jp.addEventListener("input",()=>{if(!updating){let n=tryNum(el.jp.value);if(n!=null)updateAllFromUS(n-12)}})
el.diameter.addEventListener("input",()=>{if(!updating){let n=tryNum(el.diameter.value);if(n!=null)updateAllFromUS(diameterToUs(n))}})
el.circ.addEventListener("input",()=>{if(!updating){let n=tryNum(el.circ.value);if(n!=null)updateAllFromUS(diameterToUs(n/PI))}})
el.slider.addEventListener("input",()=>{if(!updating){updateAllFromUS(parseFloat(el.slider.value))}});

updateAllFromUS(8);
</script>

</body>
</html>
